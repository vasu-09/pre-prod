server:
  port: ${SERVER_PORT:8080}

spring:
  application:
    name: ${SPRING_APPLICATION_NAME:api-gateway}
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  config:
    import: "optional:configserver:"

  cloud:
    kubernetes:
      discovery:
        enabled: ${SPRING_CLOUD_KUBERNETES_DISCOVERY_ENABLED:true}
    gateway:
      routes:
        - id: auth-service
          uri: http://auth-service.moc-preprod.svc.cluster.local:80         # service ID is stable; keep literal
          predicates:
            - Path=/auth/**,/user/**,/contacts/**,/.well-known/jwks.json,/v1/keys/**,/webhooks/sms-dlr,
#          filters:
#            - StripPrefix=1

        - id: notification-service
          uri: http://notification-service.moc-preprod.svc.cluster.local:80
          predicates:
            - Path=/notifications/**

        - id: rtc-http
          uri: http://rtc-service.moc-preprod.svc.cluster.local:80   # or http://192.168.31.6:8091
          predicates:
            - Path=/api/search/**,/api/blocks/**,/api/calls/**,/api/dm/**,/api/e2ee/**,/api/media/**,/api/message/**,/api/messages/**,/api/readmodel/**,/api/rooms/**

        - id: rtc-ws
          uri: http://rtc-service.moc-preprod.svc.cluster.local:80  # or ws://192.168.31.6:8091
          predicates:
            - Path=/ws,/ws/**,/rtc/**

        - id: todo-service
          uri: http://todo-service.moc-preprod.svc.cluster.local:80
          predicates:
            - Path=/api/v1/payments/**,/api/lists/**


      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST

      httpclient:
        connect-timeout: ${GATEWAY_CONNECT_TIMEOUT_MS:5000}
        response-timeout: ${GATEWAY_RESPONSE_TIMEOUT:10s}
        websocket:
          max-frame-payload-length: ${GATEWAY_WS_MAX_FRAME_BYTES:262144}

      httpserver:
        websocket:
          max-frame-payload-length: ${GATEWAY_WS_MAX_FRAME_BYTES:262144}

      globalcors:
        add-to-simple-url-handler-mapping: true
        corsConfigurations:
          "[/**]":
            allowedOrigins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:19006,http://localhost:19001,http://localhost:8081,http://127.0.0.1:19006,http://127.0.0.1:1900,1http://127.0.0.1:8081,http://192.168.31.6:19006,http://192.168.31.6:19001,http://192.168.31.6:8081}
            allowedOriginPatterns: ${CORS_ALLOWED_ORIGIN_PATTERNS:https://*.expo.dev,https://*.exp.direct,https://exp.host}
            allowedMethods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,PATCH,DELETE,OPTIONS}
            allowedHeaders: ${CORS_ALLOWED_HEADERS:*}
            exposedHeaders: ${CORS_EXPOSED_HEADERS:Authorization,Content-Type}
            allowCredentials: ${CORS_ALLOW_CREDENTIALS:true}
            maxAge: ${CORS_MAX_AGE:3600}

  security:
    oauth2:
      resourceserver:
        jwt:
#          jwk-set-uri: ${JWT_JWKS_URI:http://localhost:8092/.well-known/jwks.json}
          issuer-uri: ${JWT_ISSUER:http://auth-service.moc-preprod.svc.cluster.local:8092}
#          jwk-set-uri: http://localhost:8092/.well-known/jwks.json
jwt:
  audience: ${JWT_AUDIENCE:}

management:
  endpoints:
    web:
      exposure:
        include: ${MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE:health,info,prometheus}

rate:
  limit:
    requests: 60
    window-seconds: 60

gateway:
  custom-jwt:
    enabled: false

logging:
  level:
    com.yourpackage.gateway: DEBUG
